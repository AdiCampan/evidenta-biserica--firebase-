#!/bin/bash

# Hook pre-push mejorado para automatizar el build y deploy
# Permite seleccionar el entorno de deployment

export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

echo "ğŸ” Ejecutando hook pre-push para build y deploy automÃ¡tico..."

# Verificar si hay cambios sin commit
if [[ $(git status --porcelain) ]]; then
  echo "âŒ Error: Hay cambios sin commit. Por favor, haz commit de todos los cambios antes de hacer push."
  exit 1
fi

# FunciÃ³n para mostrar menÃº de selecciÃ³n de entorno
select_environment() {
  echo "ğŸŒ Selecciona el entorno de deployment:"
  echo "1) Development (evidenta-bisericii)"
  echo "2) Production (secretariat-ebenezer)"
  echo "3) Cancelar deployment"
  
  read -p "Ingresa tu opciÃ³n (1-3): " choice
  
  case $choice in
    1)
      echo "development"
      ;;
    2)
      echo "production"
      ;;
    3)
      echo "cancelled"
      ;;
    *)
      echo "âŒ OpciÃ³n invÃ¡lida. Cancelando deployment."
      echo "cancelled"
      ;;
  esac
}

# Seleccionar entorno
ENVIRONMENT=$(select_environment)

if [ "$ENVIRONMENT" = "cancelled" ]; then
  echo "ğŸš« Deployment cancelado por el usuario."
  exit 0
fi

echo "ğŸ¯ Entorno seleccionado: $ENVIRONMENT"

# Configurar el proyecto de Firebase segÃºn el entorno
if [ "$ENVIRONMENT" = "development" ]; then
  firebase use development
  echo "ğŸ”§ Configurado para entorno de desarrollo"
elif [ "$ENVIRONMENT" = "production" ]; then
  firebase use production
  echo "ğŸ”§ Configurado para entorno de producciÃ³n"
fi

# Ejecutar verificaciÃ³n de variables de entorno
echo "ğŸ” Verificando variables de entorno..."
node "$(git rev-parse --show-toplevel)/deploy-check.js"

# Si la verificaciÃ³n falla, el script se detendrÃ¡ aquÃ­ debido al cÃ³digo de salida
if [ $? -ne 0 ]; then
  echo "âŒ Error en la verificaciÃ³n de variables de entorno."
  exit 1
fi

# Ejecutar build
echo "ğŸ—ï¸ Ejecutando build..."
npm run build

# Si el build es exitoso, ejecutar deploy
if [ $? -eq 0 ]; then
  echo "ğŸš€ Ejecutando deploy en entorno $ENVIRONMENT..."
  firebase deploy
  
  if [ $? -eq 0 ]; then
    echo "âœ… Deploy completado con Ã©xito en $ENVIRONMENT."
    echo "ğŸŒ URL del proyecto:"
    if [ "$ENVIRONMENT" = "development" ]; then
      echo "   https://evidenta-bisericii.web.app"
    elif [ "$ENVIRONMENT" = "production" ]; then
      echo "   https://secretariat-ebenezer.web.app"
    fi
  else
    echo "âŒ Error durante el deploy."
    exit 1
  fi
else
  echo "âŒ Error durante el build."
  exit 1
fi

# Continuar con el push si todo fue exitoso
echo "âœ… Proceso completado. Continuando con el push..."
exit 0